Option Explicit

Public Sub GenerateReports()
    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.Calculation = xlCalculationManual

    Dim ws1 As Worksheet, ws2 As Worksheet, ws3 As Worksheet, ws4 As Worksheet
    Dim dictCRQ As Object, dictLookup As Object
    Dim lastRow1 As Long, lastRow2 As Long, r As Long, crq As Variant
    
    Set ws1 = Worksheets("Working")
    Set ws2 = Worksheets("GCA Export")
    Set ws3 = Worksheets("Reg Form 1")
    Set ws4 = Worksheets("Reg Form 2")
    
    ' Snapshot templates
    Dim tpl3 As Variant, tpl4 As Variant
    tpl3 = ws3.UsedRange.Value
    tpl4 = ws4.UsedRange.Value
    
    ' Collect unique CRQs
    Set dictCRQ = CreateObject("Scripting.Dictionary")
    lastRow1 = ws1.Cells(ws1.Rows.Count, 3).End(xlUp).Row
    For r = 2 To lastRow1
        crq = Trim(ws1.Cells(r, 3).Value)
        If Len(crq) > 0 Then If Not dictCRQ.Exists(crq) Then dictCRQ.Add crq, 1
    Next
    
    ' Build lookup dictionary from Tab 2
    Set dictLookup = CreateObject("Scripting.Dictionary")
    lastRow2 = ws2.Cells(ws2.Rows.Count, 1).End(xlUp).Row
    Dim colRegID As Long: colRegID = ws2.Rows(1).Find("RegulatedGameID").Column
    For r = 2 To lastRow2
        dictLookup(Trim(ws2.Cells(r, colRegID).Value)) = r
    Next
    
    ' Loop through each CRQ
    Dim key As Variant
    For Each key In dictCRQ.Keys
        crq = key
        
        ' --- Populate Tab 4 ---
        Dim outRow As Long: outRow = 3
        Dim rgID As Variant, rr As Long
        For r = 2 To lastRow1
            If Trim(ws1.Cells(r, 3).Value) = crq Then
                rgID = ws1.Cells(r, 4).Value
                If dictLookup.Exists(CStr(rgID)) Then
                    rr = dictLookup(CStr(rgID))
                    ws4.Cells(outRow, 1).Value = crq
                    ws4.Cells(outRow, 2).Value = ws2.Cells(rr, ws2.Rows(1).Find("GameName").Column).Value
                    ws4.Cells(outRow, 3).Value = ws2.Cells(rr, ws2.Rows(1).Find("GamesCertificateReference").Column).Value
                    ws4.Cells(outRow, 4).Value = ws2.Cells(rr, ws2.Rows(1).Find("provider").Column).Value
                    ws4.Cells(outRow, 6).Value = ws2.Cells(rr, ws2.Rows(1).Find("Delivery Channel").Column).Value
                    ws4.Cells(outRow, 7).Value = ws2.Cells(rr, ws2.Rows(1).Find("GameVersion").Column).Value
                    ws4.Cells(outRow, 8).Value = ws2.Cells(rr, ws2.Rows(1).Find("TheoreticalRTP").Column).Value
                    ws4.Cells(outRow, 9).Value = IIf(LCase(Trim(ws2.Cells(rr, ws2.Rows(1).Find("isProgrssive").Column).Value)) = "true", "Y", "N")
                    ws4.Cells(outRow, 10).Value = IIf(LCase(Trim(ws2.Cells(rr, ws2.Rows(1).Find("GameType").Column).Value)) = "slots", "Y", "N")
                    ws4.Cells(outRow, 11).Value = Format(NextBusinessDay(Date), "dd/mm/yyyy")
                    outRow = outRow + 1
                End If
            End If
        Next
        
        ' --- Populate Tab 3 ---
        Dim uniqNames As Object: Set uniqNames = CreateObject("Scripting.Dictionary")
        Dim lastRow4 As Long: lastRow4 = ws4.Cells(ws4.Rows.Count, 2).End(xlUp).Row
        For r = 3 To lastRow4
            If Len(Trim(ws4.Cells(r, 2).Value)) > 0 Then uniqNames(Trim(ws4.Cells(r, 2).Value)) = 1
        Next
        
        Dim provider As String: provider = ws4.Cells(3, 4).Value
        If uniqNames.Count = 1 Then
            ws3.Range("A1").Value = "Activate " & provider & " game " & ws4.Cells(3, 2).Value & " on Desktop & Mobile (" & crq & ")"
            ws3.Range("A4").Value = "Activate " & provider & " game " & ws4.Cells(3, 2).Value & " on Desktop & Mobile" & vbCrLf & "New Content"
        ElseIf uniqNames.Count > 1 Then
            ws3.Range("A1").Value = "Activate multiple " & provider & " games on Desktop & Mobile (" & crq & ")"
            ws3.Range("A4").Value = "Activate multiple " & provider & " games on Desktop & Mobile" & vbCrLf & "New Content"
        End If
        ws3.Range("A16").Value = Format(CDate(ws4.Range("K3").Value), "MMMM dd, yyyy") & " - 1 Hour"
        
        For r = 2 To lastRow1
            If ws1.Cells(r, 3).Value = crq Then
                ws3.Range("A19").Value = ws1.Cells(r, 2).Value
                Exit For
            End If
        Next
        ws3.Range("A28").Value = "See Games Installation Form " & crq
        ws3.Range("A34").Value = "See Games Installation Form " & crq
        
        ' --- Export ---
        With ws4.UsedRange
            .Borders.LineStyle = xlContinuous
        End With
        lastRow4_2 = ws4.Cells(ws4.Rows.Count, 1).End(xlUp).Row
        If lastRow4_2 >= 3 Then ws4.Range("E3:E" & lastRow4_2).Value = "Casino"
        ExportSheet ws4, "Game Installation Form " & crq
        ExportSheet ws3, ws3.Range("A1").Value
        
        ' --- Restore templates ---
        ws3.UsedRange.Value = tpl3
        ws4.UsedRange.Value = tpl4
    Next

    Application.ScreenUpdating = True
    Application.EnableEvents = True
    Application.Calculation = xlCalculationAutomatic

    MsgBox "All CRQ reports have been created successfully.", vbInformation
End Sub

Private Function NextBusinessDay(d As Date) As Date
    Dim nd As Date: nd = d + 1
    If Weekday(nd, vbMonday) = 6 Then nd = nd + 2
    NextBusinessDay = nd
End Function

Private Sub ExportSheet(ws As Worksheet, baseName As String)
    Dim fn As String
    fn = SanitizeFileName(baseName) & ".xlsx"
    Dim newWb As Workbook
    ws.Copy
    Set newWb = ActiveWorkbook
    newWb.SaveAs ThisWorkbook.Path & "\" & fn, xlOpenXMLWorkbook
    newWb.Close False
End Sub

Private Function SanitizeFileName(s As String) As String
    Dim badChars As Variant, i As Long
    badChars = Array(":", "\", "/", "?", "*", "[", "]", """")
    For i = LBound(badChars) To UBound(badChars)
        s = Replace(s, badChars(i), "-")
    Next
    SanitizeFileName = Trim(s)
End Function
